<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="responsive.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç®€æ˜“ç•™è¨€æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            position: relative;
            min-height: 160px; /* å¢åŠ æœ€å°é«˜åº¦ */
            display: flex;
            flex-direction: column;
        }
        .header-top {
            position: absolute;
            top: 15px;
            right: 15px;
            left: 15px;
            display: flex;
            justify-content: flex-end;
            height: 40px; /* ä¸ºæŒ‰é’®åŒºåŸŸé¢„ç•™å›ºå®šé«˜åº¦ */
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .auth-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .auth-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            margin-left: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .messages-container {
            padding: 20px;
        }

        .messages-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .message-item {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .message-author {
            font-weight: bold;
            color: #667eea;
        }

        .message-time {
            color: #999;
        }

        .message-content {
            color: #333;
            line-height: 1.5;
        }

        .no-messages {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 30px;
        }

        .error-message {
            text-align: center;
            color: #e74c3c;
            padding: 30px;
            background: #ffeaea;
            border-radius: 5px;
            margin: 10px 0;
        }

        .login-prompt {
            text-align: center;
            background: #f8f9fa;
            padding: 15px;
            margin: 20px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .login-prompt a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .login-prompt a:hover {
            text-decoration: underline;
        }

        .search-container {
            margin: 0 0 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
        }

        .search-button {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .search-button:hover {
            background-color: #764ba2;
        }

        .clear-button {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .clear-button:hover {
            background-color: #7f8c8d;
        }

        .search-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            font-size: 14px;
            color: #666;
        }
    </style>
    <script src="auth.js"></script>
</head>
<body>
<script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const authToken = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('user') || 'null');

    if (authToken && user) {
        // ç”¨æˆ·å·²ç™»å½•ï¼Œæ›´æ–°é¡µé¢æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            // æ›´æ–°é¡µé¢ä¸Šçš„ç™»å½•çŠ¶æ€
            updateAuthButtons();
        });
    }

    function updateAuthButtons() {
        const authButtons = document.querySelector('.auth-buttons');
        const loginPrompt = document.querySelector('.login-prompt');

        if (authButtons && user) {
            authButtons.innerHTML = `
                <span style="color: white; margin-right: 10px;">æ¬¢è¿ï¼Œ${user.username}</span>
                <a href="my.html" class="auth-btn">ğŸ“ æˆ‘çš„ç•™è¨€</a>
                <a href="post.html" class="auth-btn">âœï¸ å‘å¸ƒç•™è¨€</a>
                <a href="#" onclick="logout()" class="auth-btn">ğŸšª é€€å‡º</a>
            `;
        }

        // å¦‚æœå·²ç™»å½•ï¼Œéšè—ç™»å½•æç¤º
        if (loginPrompt && user) {
            loginPrompt.style.display = 'none';
        }
    }

    function logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.reload();
        }
    }
</script>
<div class="container">
    <div class="header">
        <div class="header-top">
            <div class="auth-buttons">
                <a href="login.html" class="auth-btn">ğŸ”‘ ç™»å½•</a>
                <a href="register.html" class="auth-btn">ğŸ“ æ³¨å†Œ</a>
            </div>
        </div>
        <div class="header-content">
            <h1>ğŸ’¬ ç®€æ˜“ç•™è¨€æ¿</h1>
            <p>æŸ¥çœ‹æ‰€æœ‰ç•™è¨€</p>
        </div>
    </div>

    <div class="login-prompt">
        è¯·å…ˆ<a href="login.html">ç™»å½•</a>æˆ–<a href="register.html">æ³¨å†Œ</a>æ¥å‘å¸ƒç•™è¨€å’Œç®¡ç†æ‚¨çš„ç•™è¨€
    </div>

    <div class="messages-container">
        <h2 class="messages-title">æ‰€æœ‰ç•™è¨€</h2>
        <div class="search-container">
            <input type="text" id="search-input" placeholder="æœç´¢ç•™è¨€å†…å®¹æˆ–ä½œè€…..." class="search-input">
            <button onclick="searchMessages()" class="search-button">æœç´¢</button>
            <button onclick="clearSearch()" class="clear-button">æ¸…é™¤</button>
        </div>
        <div id="messagesList">
            <!-- ç•™è¨€é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
            <div class="loading">æ­£åœ¨åŠ è½½ç•™è¨€...</div>
        </div>
    </div>
</div>

<script>
    async function searchMessages() {
        const keyword = document.getElementById('search-input').value.trim();

        if (!keyword) {
            alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            return;
        }

        const container = document.getElementById('messagesList');
        container.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(keyword)}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const messages = await response.json();

            // æ˜¾ç¤ºæœç´¢ç»“æœä¿¡æ¯
            let html = '';
            if (messages.length > 0) {
                html += `<div class="search-info">æ‰¾åˆ° ${messages.length} æ¡å…³äº "${escapeHtml(keyword)}" çš„ç•™è¨€</div>`;
            }

            if (messages.length === 0) {
                html += `
                <div class="no-messages">
                    æ²¡æœ‰æ‰¾åˆ°å…³äº "${escapeHtml(keyword)}" çš„ç•™è¨€
                </div>
            `;
            } else {
                html += messages.map(message => `
                <div class="message-item">
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(message.author)}</span>
                        <span class="message-time">${formatTime(new Date(message.timestamp))}</span>
                    </div>
                    <div class="message-content">
                        ${escapeHtml(message.content).replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');
            }

            container.innerHTML = html;

        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
            container.innerHTML = `
            <div class="error-message">
                <strong>æœç´¢å¤±è´¥</strong><br>
                é”™è¯¯è¯¦æƒ…ï¼š${error.message}
            </div>
        `;
        }
    }

    // æ¸…é™¤æœç´¢
    function clearSearch() {
        document.getElementById('search-input').value = '';
        loadMessages();
    }

    // ç›‘å¬æœç´¢è¾“å…¥æ¡†çš„Enteré”®
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchMessages();
                }
            });
        }
    });

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadMessages();

        // ç»‘å®šæœç´¢æ¡†çš„Enteré”®äº‹ä»¶
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    searchMessages();
                }
            });
        }
    });

    // ä»åç«¯åŠ è½½ç•™è¨€
    async function loadMessages() {
        const container = document.getElementById('messagesList');

        try {
            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç•™è¨€...</div>';

            const response = await fetch('/api/messages');

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const messages = await response.json();
            renderMessages(messages);
        } catch (error) {
            console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);

            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            container.innerHTML = `
                    <div class="error-message">
                        <strong>æ— æ³•åŠ è½½ç•™è¨€</strong><br>
                        é”™è¯¯è¯¦æƒ…ï¼š${error.message}<br><br>
                        <strong>è¯·æ£€æŸ¥ä»¥ä¸‹æ­¥éª¤ï¼š</strong>
                        <ol style="text-align: left; display: inline-block; margin: 10px 0;">
                            <li>ç¡®ä¿å·²å®‰è£… Node.js</li>
                            <li>åœ¨é¡¹ç›®ç›®å½•è¿è¡Œ "npm install" å®‰è£…ä¾èµ–</li>
                            <li>è¿è¡Œ "node server.js" å¯åŠ¨æœåŠ¡å™¨</li>
                            <li>ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3000</li>
                        </ol>
                    </div>
                `;
        }
    }

    // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
    function renderMessages(messages) {
        const container = document.getElementById('messagesList');

        if (!messages || messages.length === 0) {
            container.innerHTML = `
                    <div class="no-messages">
                        æš‚æ— ç•™è¨€ï¼Œè¯·å…ˆç™»å½•å¹¶å‘å¸ƒç¬¬ä¸€ä¸ªç•™è¨€ï¼
                    </div>
                `;
            return;
        }

        container.innerHTML = messages.map(message => `
                <div class="message-item">
                    <div class="message-header">
                        <span class="message-author">${escapeHtml(message.author)}</span>
                        <span class="message-time">${formatTime(new Date(message.timestamp))}</span>
                    </div>
                    <div class="message-content">
                        ${escapeHtml(message.content).replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (hours < 24) return `${hours}å°æ—¶å‰`;
        if (days < 30) return `${days}å¤©å‰`;

        return date.toLocaleDateString('zh-CN');
    }

    // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦é˜²æ­¢XSSæ”»å‡»
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
</body>
</html>