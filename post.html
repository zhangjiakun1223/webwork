
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="responsive.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å‘å¸ƒç•™è¨€ - ç®€æ˜“ç•™è¨€æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .message-form {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .submit-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .submit-btn:hover {
            background: #5a6fd8;
        }

        .messages-container {
            padding: 20px;
        }

        .messages-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .message-item {
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .message-author {
            font-weight: bold;
            color: #667eea;
        }

        .message-time {
            color: #999;
        }

        .message-content {
            color: #333;
            line-height: 1.5;
        }

        .no-messages {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .back-link {
            display: inline-block;
            margin: 20px;
            color: #667eea;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
    <script src="auth.js"></script>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ’¬ ç®€æ˜“ç•™è¨€æ¿</h1>
        <p>ç•™ä¸‹æ‚¨çš„æƒ³æ³•å’Œå»ºè®®</p>
    </div>

    <a href="index.html" class="back-link">â† è¿”å›ç•™è¨€æ¿</a>

    <!-- ç•™è¨€è¡¨å• -->
    <div class="message-form">
        <h2>å‘è¡¨æ–°ç•™è¨€</h2>
        <form id="messageForm">
            <div class="form-group">
                <label for="author">æ‚¨çš„å§“åï¼š</label>
                <input type="text" id="author" name="author" required placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            </div>
            <div class="form-group">
                <label for="content">ç•™è¨€å†…å®¹ï¼š</label>
                <textarea id="content" name="content" required placeholder="è¯·è¾“å…¥æ‚¨çš„ç•™è¨€å†…å®¹"></textarea>
            </div>
            <button type="submit" class="submit-btn">å‘å¸ƒç•™è¨€</button>
        </form>
    </div>

    <!-- ç•™è¨€åˆ—è¡¨å±•ç¤ºåŒºåŸŸ -->
    <div class="messages-container">
        <h2 class="messages-title">æ‰€æœ‰ç•™è¨€</h2>
        <div id="messagesList">
            <!-- ç•™è¨€é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
            <div class="no-messages">æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€ä¸ªç•™è¨€å§ï¼</div>
        </div>
    </div>
</div>

<script>
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadMessages();
        setupFormSubmit();

        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨å¡«å……ä½œè€…å§“å
        const user = getCurrentUser();
        if (user) {
            const authorInput = document.getElementById('author');
            if (authorInput) {
                authorInput.value = user.username;
                // å¯ä»¥è®¾ç½®ä¸ºåªè¯»æˆ–ç¦ç”¨ï¼Œå¦‚æœéœ€è¦
                // authorInput.readOnly = true;
            }
        }
    });

    // è®¾ç½®è¡¨å•æäº¤äº‹ä»¶
    function setupFormSubmit() {
        const form = document.getElementById('messageForm');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const author = document.getElementById('author').value;
            const content = document.getElementById('content').value;

            if (author && content) {
                await addMessage(author, content);
                form.reset();
            }
        });
    }

    // æ·»åŠ æ–°ç•™è¨€
    async function addMessage(author, content) {
        try {
            const token = localStorage.getItem('authToken');
            const headers = {
                'Content-Type': 'application/json'
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/messages', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ author, content })
            });

            if (response.ok) {
                loadMessages();
                alert('ç•™è¨€å‘å¸ƒæˆåŠŸï¼');
            } else {
                const result = await response.json();
                alert('ç•™è¨€å‘å¸ƒå¤±è´¥: ' + result.error);
            }
        } catch (error) {
            console.error('å‘å¸ƒç•™è¨€å¤±è´¥:', error);
            alert('å‘å¸ƒç•™è¨€æ—¶å‘ç”Ÿé”™è¯¯');
        }
    }

    // ä»åç«¯åŠ è½½ç•™è¨€
    async function loadMessages() {
        try {
            const container = document.getElementById('messagesList');

            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç•™è¨€...</div>';

            const response = await fetch('/api/messages');

            console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);

            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status} - ${response.statusText}`);
            }

            const messages = await response.json();
            console.log('è·å–åˆ°çš„ç•™è¨€æ•°æ®:', messages);
            renderMessages(messages);

        } catch (error) {
            console.error('âŒ åŠ è½½ç•™è¨€å¤±è´¥è¯¦æƒ…:', error);
            const container = document.getElementById('messagesList');
            container.innerHTML = `
            <div class="error-message">
                <strong>æ— æ³•åŠ è½½ç•™è¨€</strong><br>
                é”™è¯¯ï¼š${error.message}<br>
                <small>è¯·æ£€æŸ¥ï¼š</small><br>
                1. æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ (è¿è¡Œ "node server.js")<br>
                2. æœåŠ¡å™¨åœ°å€ï¼š${window.location.origin}<br>
                3. æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯
            </div>
        `;
        }
    }

    // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
    function renderMessages(messages) {
        const container = document.getElementById('messagesList');

        if (!messages) {
            container.innerHTML = '<div class="no-messages">æ•°æ®æ ¼å¼é”™è¯¯</div>';
            return;
        }

        if (messages.length === 0) {
            container.innerHTML = `
            <div class="no-messages">
                æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€ä¸ªç•™è¨€å§ï¼
            </div>
        `;
            return;
        }

        container.innerHTML = messages.map(message => `
        <div class="message-item">
            <div class="message-header">
                <span class="message-author">${escapeHtml(message.author || 'åŒ¿å')}</span>
                <span class="message-time">${formatTime(new Date(message.timestamp || Date.now()))}</span>
            </div>
            <div class="message-content">
                ${escapeHtml(message.content || '').replace(/\n/g, '<br>')}
            </div>
        </div>
    `).join('');
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (hours < 24) return `${hours}å°æ—¶å‰`;
        if (days < 30) return `${days}å¤©å‰`;

        return date.toLocaleDateString('zh-CN');
    }

    // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦é˜²æ­¢XSSæ”»å‡»
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    

</script>
</body>
</html>